{% extends 'base.html' %}

{% block title %}Course{% endblock %}
{% block menu %}
<div class="flex flex-col flex-1 space-y-4">
    <a href="{% url 'home' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 -0.5 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>menu_navigation_grid [#1529]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-99.000000, -200.000000)" fill="#000000"> <g id="icons" transform="translate(56.000000, 160.000000)"> <path d="M60.85,51 L57.7,51 C55.96015,51 54.55,52.343 54.55,54 L54.55,57 C54.55,58.657 55.96015,60 57.7,60 L60.85,60 C62.58985,60 64,58.657 64,57 L64,54 C64,52.343 62.58985,51 60.85,51 M49.3,51 L46.15,51 C44.41015,51 43,52.343 43,54 L43,57 C43,58.657 44.41015,60 46.15,60 L49.3,60 C51.03985,60 52.45,58.657 52.45,57 L52.45,54 C52.45,52.343 51.03985,51 49.3,51 M60.85,40 L57.7,40 C55.96015,40 54.55,41.343 54.55,43 L54.55,46 C54.55,47.657 55.96015,49 57.7,49 L60.85,49 C62.58985,49 64,47.657 64,46 L64,43 C64,41.343 62.58985,40 60.85,40 M52.45,43 L52.45,46 C52.45,47.657 51.03985,49 49.3,49 L46.15,49 C44.41015,49 43,47.657 43,46 L43,43 C43,41.343 44.41015,40 46.15,40 L49.3,40 C51.03985,40 52.45,41.343 52.45,43" id="menu_navigation_grid-[#1529]"> </path> </g> </g> </g> </g></svg>
    </a>
    {% if user.role == "teacher"%}
    <a href="{% url 'teacher_student' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg height="32px" width="32px" version="1.1" id="_x32_" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 512 512" xml:space="preserve" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <style type="text/css"> .st0{fill:#000000;} </style> <g> <path class="st0" d="M505.837,180.418L279.265,76.124c-7.349-3.385-15.177-5.093-23.265-5.093c-8.088,0-15.914,1.708-23.265,5.093 L6.163,180.418C2.418,182.149,0,185.922,0,190.045s2.418,7.896,6.163,9.627l226.572,104.294c7.349,3.385,15.177,5.101,23.265,5.101 c8.088,0,15.916-1.716,23.267-5.101l178.812-82.306v82.881c-7.096,0.8-12.63,6.84-12.63,14.138c0,6.359,4.208,11.864,10.206,13.618 l-12.092,79.791h55.676l-12.09-79.791c5.996-1.754,10.204-7.259,10.204-13.618c0-7.298-5.534-13.338-12.63-14.138v-95.148 l21.116-9.721c3.744-1.731,6.163-5.504,6.163-9.627S509.582,182.149,505.837,180.418z"></path> <path class="st0" d="M256,346.831c-11.246,0-22.143-2.391-32.386-7.104L112.793,288.71v101.638 c0,22.314,67.426,50.621,143.207,50.621c75.782,0,143.209-28.308,143.209-50.621V288.71l-110.827,51.017 C278.145,344.44,267.25,346.831,256,346.831z"></path> </g> </g></svg>    </a>
    {% endif %}
    <a href="{% url 'courses_home' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M4 19V6.2C4 5.0799 4 4.51984 4.21799 4.09202C4.40973 3.71569 4.71569 3.40973 5.09202 3.21799C5.51984 3 6.0799 3 7.2 3H16.8C17.9201 3 18.4802 3 18.908 3.21799C19.2843 3.40973 19.5903 3.71569 19.782 4.09202C20 4.51984 20 5.0799 20 6.2V17H6C4.89543 17 4 17.8954 4 19ZM4 19C4 20.1046 4.89543 21 6 21H20M9 7H15M9 11H15M19 17V21" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
    </a>
    <a href="{% url 'profile' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>profile_round [#1342]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -2159.000000)" fill="#000000"> <g id="icons" transform="translate(56.000000, 160.000000)"> <path d="M100.562548,2016.99998 L87.4381713,2016.99998 C86.7317804,2016.99998 86.2101535,2016.30298 86.4765813,2015.66198 C87.7127655,2012.69798 90.6169306,2010.99998 93.9998492,2010.99998 C97.3837885,2010.99998 100.287954,2012.69798 101.524138,2015.66198 C101.790566,2016.30298 101.268939,2016.99998 100.562548,2016.99998 M89.9166645,2004.99998 C89.9166645,2002.79398 91.7489936,2000.99998 93.9998492,2000.99998 C96.2517256,2000.99998 98.0830339,2002.79398 98.0830339,2004.99998 C98.0830339,2007.20598 96.2517256,2008.99998 93.9998492,2008.99998 C91.7489936,2008.99998 89.9166645,2007.20598 89.9166645,2004.99998 M103.955674,2016.63598 C103.213556,2013.27698 100.892265,2010.79798 97.837022,2009.67298 C99.4560048,2008.39598 100.400241,2006.33098 100.053171,2004.06998 C99.6509769,2001.44698 97.4235996,1999.34798 94.7348224,1999.04198 C91.0232075,1998.61898 87.8750721,2001.44898 87.8750721,2004.99998 C87.8750721,2006.88998 88.7692896,2008.57398 90.1636971,2009.67298 C87.1074334,2010.79798 84.7871636,2013.27698 84.044024,2016.63598 C83.7745338,2017.85698 84.7789973,2018.99998 86.0539717,2018.99998 L101.945727,2018.99998 C103.221722,2018.99998 104.226185,2017.85698 103.955674,2016.63598" id="profile_round-[#1342]"> </path> </g> </g> </g> </g></svg>
    </a>
</div>
{% endblock %}
{% block content %}
<div class="flex flex-col px-8 py-4 mx-5 bg-white shadow-sm">
    <div class="lg:flex mb-6">
        <p class="text-2xl font-semibold mb-2 lg:mb-0">Courses</p>
    </div>

    <nav class="text-sm font-semibold mb-6" aria-label="Breadcrumb">
        <ol class="list-none p-0 inline-flex">
          <li class="flex items-center text-blue-500">
            <a href="{% url 'home' %}" class="text-gray-700">Home</a>
            <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
          </li>
          <li class="flex items-center text-blue-500">
            <a href="{% url 'courses_home' %}" class="text-gray-600">Courses</a>
            <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
          </li>
          <li class="flex items-center">
            <span class="text-gray-600">{{course.course_name}}</span>
          </li>
        </ol>
    </nav>

    <div class="max-w-screen space-y-6">
        <div class="mb-4 border-gray-200 dark:border-gray-700">
            <ul class="flex flex-wrap text-sm font-medium text-center" id="tabs-menu">
                <li class="me-2">
                    <button class="tab-btn inline-block p-4 border-b-2 rounded-t-lg active-tab" data-target="#students-tab-content">
                      Students
                    </button>
                </li>
                <li class="me-2">
                  <button class="tab-btn inline-block p-4 border-b-2 rounded-t-lg" data-target="#attendance-tab-content">
                    Attendance
                  </button>
                </li>
                <li class="me-2">
                  <button class="tab-btn inline-block p-4 border-b-2 rounded-t-lg" data-target="#setting-tab-content">
                    Setting
                  </button>
                </li>
                <li class="me-2">
                  <button class="tab-btn inline-block p-4 border-b-2 rounded-t-lg" data-target="#exports-tab-content">
                    Exports
                  </button>
                </li>
                <li class="me-2">
                  <button class="tab-btn inline-block p-4 border-b-2 rounded-t-lg" data-target="#imports-tab-content">
                    Imports
                  </button>
                </li>
                <li class="ml-auto">
                    <button id="openModal" data-modal-target="crud-modal" class="text-white bg-blue-700 hover:bg-blue-800 rounded-lg px-5 py-2.5">
                        Add Student
                    </button>
                </li>
            </ul>
        </div>
    
        <!-- Tab Contents -->
        <div>
            <div id="attendance-tab-content" class="tab-content hidden p-4 rounded-lg">
                <form method="POST" action="{% url 'update_attendance' course.id %}">
                    {% csrf_token %}
                    <table class="w-full text-sm text-left text-gray-500 border-collapse border border-gray-300">
                        <thead class="bg-gray-100 text-gray-700 uppercase">
                            <tr>
                                <th class="border border-gray-300 p-3">NO</th>
                                <th class="border border-gray-300 p-3">Student</th>
                                <th class="border border-gray-300 p-3">Time</th>
                                <th class="border border-gray-300 p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attendance in attendances %}
                                <tr class="bg-white border-b">
                                    <td class="border border-gray-300 p-3">{{ forloop.counter }}</td>
                                    <td class="border border-gray-300 p-3">{{ attendance.student.first_name }} {{ attendance.student.last_name }}</td>
                                    <td class="border border-gray-300 p-3">{{ attendance.time }}</td>
                                    <td class="border border-gray-300 p-3">
                                        <select name="status_{{ attendance.id }}" class="p-2 border rounded">
                                            <option value="present" {% if attendance.status == "present" %}selected{% endif %}>Present</option>
                                            <option value="absent" {% if attendance.status == "absent" %}selected{% endif %}>Absent</option>
                                            <option value="leave" {% if attendance.status == "leave" %}selected{% endif %}>Leave</option>
                                        </select>
                                    </td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-gray-500">No attendance records for today.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                
                    <button type="submit" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                        Save Changes
                    </button>
                </form>                
            </div>
            <div id="setting-tab-content" class="tab-content hidden p-4 rounded-lg">
                <div class="flex items-center py-1">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer">
                        <div class="w-10 h-5 bg-gray-300 rounded-full peer peer-checked:bg-purple-600 transition-all duration-300"></div>
                        <div class="w-4 h-4 bg-white rounded-full absolute left-0.5 top-0.5 peer-checked:translate-x-5 transition-transform duration-300"></div>
                    </label>
                    <h4 class="px-5 text-gray-700">attendance by face</h4>
                </div>
                <form method="POST" class="py-4">
                    {% csrf_token %}
                    {% for schedule in schedules %}
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4">{{ schedule.day_of_week }}</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Start Time Input -->
                                <div>
                                    <label for="start_time_{{ schedule.day_of_week }}" class="block text-sm font-medium text-gray-700 mb-1">
                                        Start Time
                                    </label>
                                    <input
                                        type="time"
                                        id="start_time_{{ schedule.day_of_week }}"
                                        name="start_time_{{ schedule.day_of_week }}"
                                        value="{{ schedule.start_time|time:'H:i' }}"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                    />
                                </div>
                                <!-- End Time Input -->
                                <div>
                                    <label for="end_time_{{ schedule.day_of_week }}" class="block text-sm font-medium text-gray-700 mb-1">
                                        End Time
                                    </label>
                                    <input
                                        type="time"
                                        id="end_time_{{ schedule.day_of_week }}"
                                        name="end_time_{{ schedule.day_of_week }}"
                                        value="{{ schedule.end_time|time:'H:i' }}"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200"
                                    />
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    <!-- Submit Button -->
                    <button
                        type="submit"
                        class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200"
                    >
                        Update Schedule
                    </button>
                </form>
            </div>
            <div id="exports-tab-content" class="tab-content hidden p-4 rounded-lg">
                <div class="container mx-auto p-4">
                    <div class="flex mb-4">
                        <input type="date" id="start-date" class="border border-gray-300 rounded-lg p-2 mr-4">
                        <input type="date" id="end-date" class="border border-gray-300 rounded-lg p-2 mr-4">
                        <button id="filter-btn" class="bg-blue-500 text-white rounded-lg p-2 hover:bg-blue-600 transition duration-300">Filter</button>
                        <div id="download-csv-url" data-url="{% url 'download_attendance_csv' course.id %}"><button id="download-csv-btn" class="bg-blue-500 text-white rounded-lg p-2 hover:bg-blue-600 transition duration-300 ml-4">Download CSV</button></div>
                    </div>
                
                    <table id="attendance-results" class="min-w-full text-center bg-white border border-gray-300">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="py-2 px-4 border-b">Date</th>
                                <th class="py-2 px-4 border-b">Email</th>
                                <th class="py-2 px-4 border-b">First Name</th>
                                <th class="py-2 px-4 border-b">Last Name</th>
                                <th class="py-2 px-4 border-b">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="imports-tab-content" class="tab-content hidden p-4 rounded-lg">
                <h1 class="text-2xl font-bold mb-4 text-gray-800">อัปโหลดและแสดงไฟล์ CSV</h1>
                <input
                  type="file"
                  id="csvFileInput"
                  accept=".csv"
                  class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-6"
                />
                <div id="columnSelection" class="hidden mb-6">
                  <label for="emailColumn" class="block text-sm font-medium text-gray-700">เลือกคอลัมน์ email</label>
                  <select id="emailColumn" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                  </select>
                  <button id="confirmSelection" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">ยืนยัน</button>
                </div>
                <div class="overflow-x-auto">
                  <table id="csvTable" class="min-w-full bg-white border border-gray-200"></table>
                </div>
            </div>
            <div id="students-tab-content" class="tab-content p-4 rounded-lg">
                <div class="flex items-center justify-between flex-column flex-wrap md:flex-row space-y-4 md:space-y-0 pb-4 bg-white">
                    <label for="table-search" class="sr-only">Search</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 rtl:inset-r-0 start-0 flex items-center ps-3 pointer-events-none">
                            <svg class="w-4 h-4 text-gray-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                            </svg>
                        </div>
                        <input type="text" id="table-search-users" class="block p-2 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg w-80 bg-white focus:ring-blue-500 focus:border-blue-500" placeholder="Search for users">
                    </div>
                </div>
                <table class="w-full text-sm text-left rtl:text-right text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="p-4">
                                <div class="flex items-center">
                                    <input id="checkbox-all-search" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500">
                                    <label for="checkbox-all-search" class="sr-only">checkbox</label>
                                </div>
                            </th>
                            <th scope="col" class="px-6 py-3">
                                Name
                            </th>
                            <th scope="col" class="px-6 py-3">
                                Invited
                            </th>
                            <th scope="col" class="px-6 py-3">
                                Status
                            </th>
                            <th scope="col" class="px-6 py-3">
                                Action
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in enrollments %}
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="w-4 p-4">
                                <div class="flex items-center">
                                    <input id="checkbox-table-search-1" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-blue-500">
                                    <label for="checkbox-table-search-1" class="sr-only">checkbox</label>
                                </div>
                            </td>
                            <th scope="row" class="flex items-center px-6 py-4 text-gray-900 whitespace-nowrap">
                                {% if enrollment.student.profile_path.url %}
                                <img class="w-10 h-10 rounded-full" src="{{enrollment.student.profile_path.url}}" alt="Jese image">
                                <div class="ps-3">
                                    <div class="text-base font-semibold">{{enrollment.student.first_name}} {{enrollment.student.last_name}}</div>
                                    <div class="font-normal text-gray-500">{{enrollment.student.email}}</div>
                                </div>  
                                {% else %}
                                <div class="w-10 h-10 rounded-full flex items-center text-sm text-blue-800 border-blue-300 rounded-lg dark:text-blue-400 dark:border-blue-800" role="alert">
                                    <svg class="shrink-0 inline w-4 h-4 me-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                                      <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5ZM9.5 4a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM12 15H8a1 1 0 0 1 0-2h1v-3H8a1 1 0 0 1 0-2h2a1 1 0 0 1 1 1v4h1a1 1 0 0 1 0 2Z"/>
                                    </svg>
                                </div>
                                <div class="ps-3">
                                    <div class="text-base font-semibold">รอผู้ใช้สมัครบัญชี</div>
                                    <div class="font-normal text-gray-500">{{enrollment.email}}</div>
                                </div>  
                                {% endif %}
                            </th>
                            <td class="px-6 py-4">
                                {{enrollment.created_at}}
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    {% if enrollment.student %}
                                    <div class="h-2.5 w-2.5 rounded-full bg-green-500 me-2"></div>Completed
                                    {% else %}
                                    <div class="h-2.5 w-2.5 rounded-full bg-red-500 me-2"></div>Pending
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <form class="delete-form" action="{% url 'kick_student' enrollment.id %}" method="POST" data-student-id="{{ enrollment.student.id }}">
                                    {% csrf_token %}
                                    <button type="submit" class="font-medium text-blue-600 hover:underline">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>                
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div id="crud-modal" class="hidden fixed inset-0 z-50 flex justify-center items-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <!-- Header -->
      <div class="flex justify-between items-center border-b pb-4 mb-4">
        <h3 class="text-lg font-semibold">Add Student {{ course.course_name }}</h3>
        <button id="closeModal" class="text-gray-400 hover:text-gray-900 focus:outline-none">
          &times;
        </button>
      </div>
  
      <!-- Form -->
      <form id="studentForm">
        <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label>
        <input type="email" id="email" name="email" required 
               class="bg-gray-50 border border-gray-300 text-gray-900 rounded-lg w-full p-2 mb-4" 
               placeholder="example@student.com">
        <button type="submit" 
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none font-medium rounded-lg px-4 py-2">
          Add Student
        </button>
      </form>
    </div>
</div>
{% endblock %}
{% block script %}
document.getElementById('openModal').addEventListener('click', function() {
    document.getElementById('crud-modal').classList.remove('hidden');
});

document.getElementById('closeModal').addEventListener('click', function() {
    document.getElementById('crud-modal').classList.add('hidden');
});

window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('crud-modal')) {
        document.getElementById('crud-modal').classList.add('hidden');
    }
});
document.addEventListener("DOMContentLoaded", function () {
    const forms = document.querySelectorAll(".delete-form");

    forms.forEach(form => {
        form.addEventListener("submit", function (event) {
            event.preventDefault();  

            const formData = new FormData(form);
            const studentId = form.getAttribute("data-student-id");

            fetch(form.action, {
                method: "POST",
                body: formData
            })
            .then(response => response.json()) 
            .then(data => {
                if (data.success) {
                    alert(data.message);  
                    document.querySelector(`[data-student-id="${studentId}"]`).closest('tr').remove();
                } else {
                    alert(data.message);  
                }
            })
            .catch(error => {
                alert("An error occurred: " + error); 
            });
        });
    });
});

document.getElementById('csvFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n');
        const headers = rows[0].split(','); 
  
        // แสดงตาราง CSV
        let table = '';
        rows.forEach((row, index) => {
          const cells = row.split(',');
          table += '<tr class="' + (index === 0 ? 'bg-gray-50' : 'hover:bg-gray-50') + '">';
          cells.forEach(cell => {
            if (index === 0) {
              table += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${cell}</th>`;
            } else {
              table += `<td class="px-6 py-4 text-sm text-gray-700">${cell}</td>`;
            }
          });
          table += '</tr>';
        });
        document.getElementById('csvTable').innerHTML = table;
  
        // แสดงตัวเลือกคอลัมน์
        const columnSelection = document.getElementById('columnSelection');
        const emailColumnSelect = document.getElementById('emailColumn');
        emailColumnSelect.innerHTML = headers.map(header => `<option value="${header}">${header}</option>`).join('');
        columnSelection.classList.remove('hidden');
      };
      reader.readAsText(file);
    }
  });
  
  document.getElementById('confirmSelection').addEventListener('click', function() {
    event.preventDefault();
    const emailColumn = document.getElementById('emailColumn').value;
    const file = document.getElementById('csvFileInput').files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n');
        const headers = rows[0].split(',');
  
        const emailIndex = headers.indexOf(emailColumn);
  
        const enrollments = [];
        rows.slice(1).forEach(row => {
          const cells = row.split(',');
          const email = cells[emailIndex];
          if (email) {
            enrollments.push({ email });
          }
        });
  
        fetch('{% url "import_enrollments" course.id %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
          },
          body: JSON.stringify({ enrollments }),
        })
          .then(response => response.json())
          .then(data => {
            console.log('Success:', data);
            alert('สร้าง Enrollment สำเร็จ!');
          })
          .catch((error) => {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการสร้าง Enrollment');
          });
      };
      reader.readAsText(file);
    }
});

document.getElementById('studentForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const email = document.getElementById('email').value;
    const courseId = {{ course.id }};
    
    fetch(`{% url 'teacher_add_student' course.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `email=${encodeURIComponent(email)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            document.getElementById('crud-modal').classList.add('hidden');
        } else {
            alert(data.message);
        }
    })
    .catch(error => console.error('Error:', error));
});

document.querySelectorAll(".tab-btn").forEach((button) => {
    button.addEventListener("click", () => {
      const target = button.dataset.target;

      document.querySelectorAll(".tab-content").forEach((content) => {
        content.classList.add("hidden");
      });

      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.classList.remove("active-tab", "text-purple-600", "border-purple-600");
      });

      document.querySelector(target).classList.remove("hidden");

      button.classList.add("active-tab", "text-purple-600", "border-purple-600");
    });
});
const attendances = {{ attendances_data|safe }};

document.getElementById('filter-btn').addEventListener('click', function(e) {
    e.preventDefault();

    const startDateInput = document.getElementById('start-date').value;
    const endDateInput = document.getElementById('end-date').value;
    const resultDiv = document.getElementById('attendance-results').getElementsByTagName('tbody')[0];

    resultDiv.innerHTML = '';

    if (!startDateInput || !endDateInput) {
        alert('Please select both start and end dates.');
        return;
    }

    const startDate = new Date(startDateInput);
    const endDate = new Date(endDateInput);

    if (!attendances || attendances.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" class="py-2 px-4 text-center text-gray-500">No attendance data available.</td>`;
        resultDiv.appendChild(row);
        return;
    }

    const filteredAttendances = attendances.filter(item => {
        try {
            const attendanceDate = new Date(item.date);
            return attendanceDate >= startDate && attendanceDate <= endDate;
        } catch (error) {
            console.error('Error parsing date:', error);
            return false;
        }
    });

    if (filteredAttendances.length > 0) {
        filteredAttendances.forEach(attendance => {
            const row = document.createElement('tr');
            row.classList.add('border-b', 'hover:bg-gray-50');

            row.innerHTML = `
                <td class="py-2 px-4">${attendance.date}</td>
                <td class="py-2 px-4">${attendance.student__email}</td>
                <td class="py-2 px-4">${attendance.student__first_name}</td>
                <td class="py-2 px-4">${attendance.student__last_name}</td>
                <td class="py-2 px-4">${attendance.status}</td>
            `;

            resultDiv.appendChild(row);
        });
    } else {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" class="py-2 px-4 text-center text-gray-500">No attendances found for the selected date range.</td>`;
        resultDiv.appendChild(row);
    }
});

document.getElementById('download-csv-btn').addEventListener('click', function(e) {
    e.preventDefault();

    const startDateInput = document.getElementById('start-date').value;
    const endDateInput = document.getElementById('end-date').value;

    if (!startDateInput || !endDateInput) {
        alert('Please select both start and end dates.');
        return;
    }

    const downloadUrl = document.getElementById('download-csv-url').getAttribute('data-url');
    
    window.location.href = `${downloadUrl}?start_date=${startDateInput}&end_date=${endDateInput}`;
});
{% endblock %}