{% extends 'base.html' %}

{% block title %}Profile{% endblock %}
{% block menu %}
<div class="flex flex-col flex-1 space-y-4">
    <a href="{% url 'home' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 -0.5 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>menu_navigation_grid [#1529]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-99.000000, -200.000000)" fill="#000000"> <g id="icons" transform="translate(56.000000, 160.000000)"> <path d="M60.85,51 L57.7,51 C55.96015,51 54.55,52.343 54.55,54 L54.55,57 C54.55,58.657 55.96015,60 57.7,60 L60.85,60 C62.58985,60 64,58.657 64,57 L64,54 C64,52.343 62.58985,51 60.85,51 M49.3,51 L46.15,51 C44.41015,51 43,52.343 43,54 L43,57 C43,58.657 44.41015,60 46.15,60 L49.3,60 C51.03985,60 52.45,58.657 52.45,57 L52.45,54 C52.45,52.343 51.03985,51 49.3,51 M60.85,40 L57.7,40 C55.96015,40 54.55,41.343 54.55,43 L54.55,46 C54.55,47.657 55.96015,49 57.7,49 L60.85,49 C62.58985,49 64,47.657 64,46 L64,43 C64,41.343 62.58985,40 60.85,40 M52.45,43 L52.45,46 C52.45,47.657 51.03985,49 49.3,49 L46.15,49 C44.41015,49 43,47.657 43,46 L43,43 C43,41.343 44.41015,40 46.15,40 L49.3,40 C51.03985,40 52.45,41.343 52.45,43" id="menu_navigation_grid-[#1529]"> </path> </g> </g> </g> </g></svg>
    </a>
</div>
{% endblock %}
{% block content %}
<div class="flex flex-col px-8 py-4 mx-5 bg-white shadow-sm">
    <div class="lg:flex mb-6">
        <p class="text-2xl font-semibold mb-2 lg:mb-0">Profile</p>
    </div>

    <nav class="text-sm font-semibold mb-6" aria-label="Breadcrumb">
        <ol class="list-none p-0 inline-flex">
          <li class="flex items-center text-blue-500">
            <a href="{% url 'home' %}" class="text-gray-700">Home</a>
            <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
          </li>
          <li class="flex items-center">
            <a href="{% url 'profile' %}" class="text-gray-600">Profile</a>
          </li>
        </ol>
    </nav>

    <div class="flex flex-wrap -mx-3 mb-20">
      <!-- Left: Profile Picture -->
      <div class="w-full lg:w-1/3 px-3 mb-6 lg:mb-0">
        <div class="flex flex-col justify-center items-center h-full">
          <img 
            id="preview"
            class="w-32 h-32 rounded-full border-4 border-gray-200 shadow-md" 
            src="{{ user.profile_path.url }}" 
            alt="Profile Picture">
          
          <form method="POST" enctype="multipart/form-data" id="profileForm">
            {% csrf_token %}
            <input 
              type="file" 
              name="profile_picture" 
              id="profilePicture" 
              accept="image/*"
              class="hidden">
            
            <button 
              type="button"
              onclick="document.getElementById('profilePicture').click()"
              class="mt-4 px-4 py-2 bg-purple-900 text-white rounded-lg hover:bg-blue-600">
              Change Picture
            </button>
          </form>
        </div>
      </div>
      
      <!-- Right: User Information -->
      <div class="w-full lg:w-2/3 px-3">
        <div class="w-full px-3">
          <div class="bg-gray-50 p-6 rounded-lg shadow-md">
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="username">Username</label>
              <p class="w-full px-4 py-2 border border-gray-300 rounded-lg">{{ user.username }}</p>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="email">Email</label>
              <p class="w-full px-4 py-2 border border-gray-300 rounded-lg">{{ user.email }}</p>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="first_name">First Name</label>
              <p class="w-full px-4 py-2 border border-gray-300 rounded-lg">{{ user.first_name }}</p>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1" for="last_name">Last Name</label>
              <p class="w-full px-4 py-2 border border-gray-300 rounded-lg">{{ user.last_name }}</p>
            </div>
          </div>
          <div class="flex justify-end">
            <button 
              type="submit"
              onclick="document.getElementById('upload-modal').classList.remove('hidden');"
              class="px-5 py-2 bg-purple-900 text-white rounded-lg hover:bg-blue-600 my-3">
              Upload Images
            </button>
          </div>
        </div>
      </div>
    </div>   
</div>
<div class="relative">
  <!-- Updated Modal Template -->
  <div id="upload-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
    <div class="max-w-md border rounded-lg bg-white p-5 shadow-lg">
      <div class="flex mb-4">
        <div>
          <svg class="w-6 h-6 fill-current text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0V0z" fill="none"/>
            <path d="M11 7h2v2h-2zm0 4h2v6h-2zm1-9C6.48 2 2 6.48 2 12s4.48 10 10 10 10-3.59 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
          </svg>
        </div>
        <div class="ml-3">
          <h2 class="font-semibold text-gray-800">Upload Photos</h2>
          <p class="mt-2 text-sm text-gray-600 leading-relaxed">
            กรุณาอัพโหลดรูปภาพของคุณอย่างน้อย 3 รูป โดยต้องประกอบด้วย:
            <br>• รูปหันซ้าย (Left Profile)
            <br>• รูปหันขวา (Right Profile)
            <br>• รูปหน้าตรง (Frontal Face)
          </p>
        </div>
      </div>
      
      <form id="upload-form" class="space-y-4">
        {% csrf_token %}
        <div class="space-y-3">
          <div class="w-full">
            <label class="block text-sm font-medium text-gray-700">Upload Images</label>
            <input type="file" name="images" accept="image/*" multiple 
                  class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm" required>
          </div>
          
          <div id="preview-container" class="grid grid-cols-2 gap-2">
            <!-- Image previews will be inserted here -->
          </div>
          
          <div id="pose-results" class="text-sm">
            <!-- Pose detection results will be shown here -->
          </div>
        </div>
        
        <div class="flex justify-end space-x-2 mt-4">
          <button type="button" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200" 
                  onclick="closeModal()">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
            Upload
          </button>
        </div>
      </form>
    </div>
  </div>

  </div>
</div>
{% endblock %}
{% block script %}
document.getElementById('upload-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const submitButton = this.querySelector('button[type="submit"]');
  const poseResults = document.getElementById('pose-results');
  
  try {
    submitButton.disabled = true;
    submitButton.innerHTML = 'Processing...';
    poseResults.innerHTML = 'Validating images...';
    
    // First validate the face poses
    const validateResponse = await fetch('{% url "validate_face_poses" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
    
    const validateResult = await validateResponse.json();
    
    // Display pose detection results
    let resultsHtml = '<div class="mt-4">';
    if (validateResult.poses_detected) {
      validateResult.poses_detected.forEach(item => {
        resultsHtml += `<div class="text-sm ${validateResult.valid ? 'text-green-600' : 'text-red-600'}">
          ${item.filename}: ${item.pose}
        </div>`;
      });
    }
    if (validateResult.errors.length > 0) {
      resultsHtml += '<div class="text-red-600 mt-2">' + 
        validateResult.errors.join('<br>') + '</div>';
    }
    resultsHtml += '</div>';
    poseResults.innerHTML = resultsHtml;
    
    if (validateResult.valid) {
      // If validation passes, save the images
      const saveResponse = await fetch('{% url "save_training_images" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });
      
      const saveResult = await saveResponse.json();
      
      if (saveResult.success) {
        alert('Images uploaded successfully!');
        closeModal();
      } else {
        alert('Error saving images: ' + saveResult.errors.join('\n'));
      }
    }
  } catch (error) {
    console.error('Error:', error);
    alert('An error occurred while processing your request.');
  } finally {
    submitButton.disabled = false;
    submitButton.innerHTML = 'Upload';
  }
});

// Show image previews
document.querySelector('input[type="file"]').addEventListener('change', function(e) {
  const previewContainer = document.getElementById('preview-container');
  previewContainer.innerHTML = '';
  
  Array.from(this.files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewContainer.innerHTML += `
        <div class="relative">
          <img src="${e.target.result}" class="w-full h-32 object-cover rounded">
          <div class="text-xs mt-1 truncate">${file.name}</div>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  });
});

function closeModal() {
  document.getElementById('upload-modal').classList.add('hidden');
}

document.getElementById('profilePicture').addEventListener('change', function() {
  const file = this.files[0];
  if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
          document.getElementById('preview').src = e.target.result;
      }
      reader.readAsDataURL(file);
      
      document.getElementById('profileForm').submit();
  }
});
{% endblock %}