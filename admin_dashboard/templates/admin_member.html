{% extends 'base.html' %}

{% block title %}Admin Dashboard{% endblock %}
{% block menu %}
<div class="flex flex-col flex-1 space-y-4">
    <a href="{% url 'home' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 -0.5 21 21" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>menu_navigation_grid [#1529]</title> <desc>Created with Sketch.</desc> <defs> </defs> <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"> <g id="Dribbble-Light-Preview" transform="translate(-99.000000, -200.000000)" fill="#000000"> <g id="icons" transform="translate(56.000000, 160.000000)"> <path d="M60.85,51 L57.7,51 C55.96015,51 54.55,52.343 54.55,54 L54.55,57 C54.55,58.657 55.96015,60 57.7,60 L60.85,60 C62.58985,60 64,58.657 64,57 L64,54 C64,52.343 62.58985,51 60.85,51 M49.3,51 L46.15,51 C44.41015,51 43,52.343 43,54 L43,57 C43,58.657 44.41015,60 46.15,60 L49.3,60 C51.03985,60 52.45,58.657 52.45,57 L52.45,54 C52.45,52.343 51.03985,51 49.3,51 M60.85,40 L57.7,40 C55.96015,40 54.55,41.343 54.55,43 L54.55,46 C54.55,47.657 55.96015,49 57.7,49 L60.85,49 C62.58985,49 64,47.657 64,46 L64,43 C64,41.343 62.58985,40 60.85,40 M52.45,43 L52.45,46 C52.45,47.657 51.03985,49 49.3,49 L46.15,49 C44.41015,49 43,47.657 43,46 L43,43 C43,41.343 44.41015,40 46.15,40 L49.3,40 C51.03985,40 52.45,41.343 52.45,43" id="menu_navigation_grid-[#1529]"> </path> </g> </g> </g> </g></svg>
    </a>
    <a href="{% url 'admin_members' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg fill="#000000" width="32px" height="32px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>member-card</title> <path d="M0 26.016q0 0.832 0.576 1.408t1.44 0.576h5.984v-1.984h-0.992q-0.416 0-0.704-0.288t-0.288-0.704 0.288-0.704 0.704-0.32h4q0.384 0 0.704 0.32t0.288 0.704-0.288 0.704-0.704 0.288h-0.992v1.984h12v-1.984h-1.024q-0.384 0-0.704-0.288t-0.288-0.704 0.288-0.704 0.704-0.32h4q0.416 0 0.704 0.32t0.32 0.704-0.32 0.704-0.704 0.288h-0.992v1.984h6.016q0.8 0 1.408-0.576t0.576-1.408v-20q0-0.832-0.576-1.408t-1.408-0.608h-28q-0.832 0-1.44 0.608t-0.576 1.408v20zM4 22.016v-14.016h14.016v14.016h-14.016zM7.040 20h7.936q-1.12-1.472-2.976-1.856v-0.32q0.896-0.352 1.44-1.088t0.576-1.728v-1.984q0-1.248-0.896-2.144t-2.112-0.864-2.144 0.864-0.864 2.144v1.984q0 0.96 0.544 1.728t1.472 1.088v0.32q-1.856 0.384-2.976 1.856zM20 22.016v-2.016h2.016v2.016h-2.016zM20 18.016v-2.016h10.016v2.016h-10.016zM20 14.016v-2.016h4v2.016h-4zM20 10.016v-2.016h6.016v2.016h-6.016zM26.016 14.016v-2.016h4v2.016h-4zM28 10.016v-2.016h2.016v2.016h-2.016z"></path> </g></svg>    
    </a>
    <a href="{% url 'admin_import_data' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M978.578286 900.461714l-108.617143-108.617143c30.134857-39.570286 48.274286-88.795429 48.274286-142.189714a235.739429 235.739429 0 0 0-235.52-235.373714 235.739429 235.739429 0 0 0-235.373715 235.373714 235.739429 235.739429 0 0 0 235.446857 235.52c53.467429 0 102.692571-18.139429 142.189715-48.274286l108.617143 108.544a31.524571 31.524571 0 0 0 44.836571 0 31.744 31.744 0 0 0 0.146286-44.982857zM510.902857 649.654857a172.105143 172.105143 0 0 1 171.885714-171.885714 171.885714 171.885714 0 0 1 0 343.771428 172.178286 172.178286 0 0 1-171.885714-171.885714z m270.262857-378.514286c0 17.554286-14.262857 31.744-31.817143 31.744H431.396571a31.744 31.744 0 0 1 0-63.488h317.952c17.554286 0 31.817143 14.189714 31.817143 31.744z m-609.426285 620.032h211.968a31.890286 31.890286 0 0 1 0 63.634286H171.739429c-58.368 0-106.057143-47.542857-106.057143-106.057143V283.062857c0-14.262857 5.12-28.086857 14.262857-39.058286L240.420571 53.101714a57.417143 57.417143 0 0 1 43.885715-20.48h517.997714c58.441143 0 106.057143 47.542857 106.057143 106.057143V366.445714a31.744 31.744 0 0 1-63.634286 0V138.605714a42.422857 42.422857 0 0 0-42.276571-42.349714H336.018286V280.137143a50.688 50.688 0 0 1-50.980572 50.176H129.389714v518.509714c0 23.332571 19.017143 42.349714 42.349715 42.349714zM272.457143 113.810286l-128.512 152.868571h128.512v-152.868571z m79.506286 476.16a31.744 31.744 0 0 0 0-63.634286H240.64a31.744 31.744 0 0 0 0 63.634286h111.323429z m0 146.066285a31.744 31.744 0 0 0 0-63.561142H240.64a31.744 31.744 0 0 0 0 63.561142h111.323429z m31.744-353.206857H240.64a31.744 31.744 0 0 0 0 63.561143h143.067429a31.744 31.744 0 0 0 0-63.561143z" fill="#000000"></path></g></svg>    
    </a>
    <a href="{% url 'admin_config' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg fill="#000000" width="32px" height="32px" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M31.449 6.748c-0.337-0.155-0.737-0.096-1.017 0.152l-5.041 4.528-4.551-4.669 4.506-5.204c0.245-0.283 0.305-0.673 0.152-1.016s-0.489-0.553-0.86-0.553h-0.271c-2.785 0-7.593 0.239-9.739 2.417l-0.433 0.43c-2.29 2.337-2.697 6.168-1.49 9.081l-11.54 11.778c-1.556 1.578-1.556 4.135 0 5.713l1.409 1.428c0.778 0.788 1.798 1.183 2.818 1.183s2.040-0.395 2.817-1.183l11.71-11.804c1.107 0.599 2.625 0.989 3.899 0.989 2.043 0 3.98-0.824 5.454-2.32l0.427-0.433c2.331-2.364 2.296-7.416 2.306-9.638 0.001-0.378-0.216-0.721-0.554-0.878zM28.302 15.906l-0.371 0.433c-1.117 1.134-2.578 1.677-4.114 1.677-0.76 0-1.784-0.143-2.476-0.431-0.625-0.259-1.206-0.634-1.725-1.107l-12.818 12.925c-0.376 0.382-0.876 0.592-1.408 0.592s-1.032-0.21-1.409-0.592l-1.408-1.427c-0.777-0.788-0.777-2.070-0.001-2.857l12.524-12.777c-0.42-0.611-0.706-1.278-0.877-1.968h-0.001c-0.482-1.95-0.201-4.644 1.313-6.189l0.431-0.435c1.298-1.317 4.67-1.707 6.537-1.822l-3.668 4.236c-0.328 0.379-0.311 0.95 0.038 1.309l5.798 5.948c0.352 0.362 0.92 0.383 1.299 0.047l4.082-3.676c-0.122 1.98-0.506 4.856-1.748 6.115z"></path> </g></svg>    
    </a>
    <a href="{% url 'admin_dashboard' %}" class="p-3 rounded-lg hover:bg-purple-100">
        <svg width="32px" height="32px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="System / Data"> <path id="Vector" d="M18 12V17C18 18.6569 15.3137 20 12 20C8.68629 20 6 18.6569 6 17V12M18 12V7M18 12C18 13.6569 15.3137 15 12 15C8.68629 15 6 13.6569 6 12M18 7C18 5.34315 15.3137 4 12 4C8.68629 4 6 5.34315 6 7M18 7C18 8.65685 15.3137 10 12 10C8.68629 10 6 8.65685 6 7M6 12V7" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g> </g></svg>
    </a>
</div>
{% endblock %}
{% block content %}
<div class="flex flex-col px-8 py-4 mx-5 bg-white shadow-sm">
    <div class="lg:flex mb-6">
        <p class="text-2xl font-semibold mb-2 lg:mb-0">Dashboard</p>
    </div>

    <nav class="text-sm font-semibold mb-6" aria-label="Breadcrumb">
        <ol class="list-none p-0 inline-flex">
          <li class="flex items-center text-blue-500">
            <a href="{% url 'home' %}" class="text-gray-700">Dashboard</a>
            <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
          </li>
          <li class="flex items-center">
            <a href="{% url 'admin_members' %}" class="text-gray-600">Members</a>
          </li>
        </ol>
    </nav>

    <div class="flex flex-wrap flex-col md:flex-row md:mb-20">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 w-full">
            <p class="text-2xl font-semibold">All Members ({{ all_members.count }})</p>
            
            <div class="flex items-center space-x-3">
                <!-- ช่องค้นหา -->
                <input type="text" id="searchInput" class="px-4 py-2 border rounded-lg w-64" placeholder="Search Members...">
                
                <!-- ตัวกรอง Role -->
                <select id="filterRole" class="border rounded-lg px-3 py-2">
                    <option value="">All Roles</option>
                    <option value="admin">Admin</option>
                    <option value="teacher">Teacher</option>
                    <option value="student">Student</option>
                </select>
            </div>
        </div>

        <!-- Member Grid -->
        <div id="memberGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 w-full">
            {% for member in all_members %}
            <div class="member-card relative bg-white shadow-md p-4 rounded-lg text-center"
                data-role="{{ member.role }}" data-date="{{ member.date_joined|date:'Y-m-d' }}">
                <!-- Member Avatar -->
                <img src="{{ member.profile_path.url }}" alt="{{ member.full_name }}" class="w-24 h-24 mx-auto rounded-full border">

                <!-- Member Info -->
                <p class="mt-3 font-semibold text-gray-900">{{ member.first_name }} {{ member.last_name }}</p>
                <p class="text-sm text-gray-600">{{ member.role }}</p>
                <p class="text-xs text-gray-500">{{ member.email }}</p>

                <button class="absolute top-3 right-3 text-gray-500 hover:text-gray-900 open-modal" data-url="{% url 'get_member_detail' member.id %}">
                    <svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path fill-rule="evenodd" clip-rule="evenodd" d="M12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9ZM11 12C11 11.4477 11.4477 11 12 11C12.5523 11 13 11.4477 13 12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12Z" fill="#000000"></path> <path fill-rule="evenodd" clip-rule="evenodd" d="M21.83 11.2807C19.542 7.15186 15.8122 5 12 5C8.18777 5 4.45796 7.15186 2.17003 11.2807C1.94637 11.6844 1.94361 12.1821 2.16029 12.5876C4.41183 16.8013 8.1628 19 12 19C15.8372 19 19.5882 16.8013 21.8397 12.5876C22.0564 12.1821 22.0536 11.6844 21.83 11.2807ZM12 17C9.06097 17 6.04052 15.3724 4.09173 11.9487C6.06862 8.59614 9.07319 7 12 7C14.9268 7 17.9314 8.59614 19.9083 11.9487C17.9595 15.3724 14.939 17 12 17Z" fill="#000000"></path> </g></svg>
                </button>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<!-- User Detail Modal -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
        <!-- Header -->
        <div class="flex justify-between items-center border-b pb-3">
            <h2 class="text-xl font-semibold text-gray-800">User Details</h2>
            <button id="closeModal" class="text-gray-600 hover:text-gray-900">
                <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 8L8 16M8.00001 8L16 16M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" 
                          stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </button>
        </div>

        <div class="text-center mt-4">
            <img id="userAvatar" src="" alt="User Avatar" class="w-24 h-24 mx-auto rounded-full border shadow-md">
            <h3 id="userFullName" class="text-lg font-semibold text-gray-900 mt-2"></h3>
            <p id="userRole" class="text-sm text-gray-500"></p>
        </div>

        <div id="userDetailContent" class="mt-6 space-y-2 text-gray-700">
            <!-- เนื้อหาถูกโหลดด้วย JavaScript -->
        </div>

        <!-- เพิ่มปุ่ม Edit ใน Modal -->
        <div class="flex justify-end space-x-3 mt-6">
            <button id="editUserBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                Edit
            </button>
            <button id="closeModalBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Close
            </button>
        </div>

    </div>
</div>
<!-- User Edit Modal -->
<div id="editUserModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative">
        <!-- Header -->
        <div class="flex justify-between items-center border-b pb-3">
            <h2 class="text-xl font-semibold text-gray-800">Edit User</h2>
            <button id="closeEditModal" class="text-gray-600 hover:text-gray-900">
                <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16 8L8 16M8.00001 8L16 16M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" 
                          stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </button>
        </div>

        <!-- Edit Form -->
        <form id="editUserForm">
            {% csrf_token %}
            <input type="hidden" id="editUserId" name="user_id">
            
            <div class="mt-4 space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">First Name</label>
                    <input type="text" id="editFirstName" name="first_name"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Last Name</label>
                    <input type="text" id="editLastName" name="last_name"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Email</label>
                    <input type="email" id="editEmail" name="email"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Role</label>
                    <select id="editRole" name="role"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="admin">Admin</option>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                    </select>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="mt-6 flex justify-end space-x-3">
                <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                    Save Changes
                </button>
                <button id="closeEditModalBtn" type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
{% block script %}
document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("searchInput").addEventListener("input", function() {
        let query = this.value.toLowerCase();
        document.querySelectorAll(".member-card").forEach(card => {
            let name = card.querySelector("p.font-semibold").innerText.toLowerCase();
            card.style.display = name.includes(query) ? "block" : "none";
        });
    });

    document.getElementById("filterRole").addEventListener("change", function() {
        let selectedRole = this.value;
        document.querySelectorAll(".member-card").forEach(card => {
            let memberRole = card.getAttribute("data-role");
            card.style.display = (!selectedRole || memberRole === selectedRole) ? "block" : "none";
        });
    });

    document.querySelectorAll(".open-modal").forEach(button => {
        button.addEventListener("click", function() {
            let url = this.getAttribute("data-url");

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("userAvatar").src = data.userAvatar;
                    document.getElementById("userFullName").textContent = `${data.first_name} ${data.last_name}`;
                    document.getElementById("userRole").textContent = data.role;

                    document.getElementById("userFullName").setAttribute("data-user-id", data.id);
                    document.getElementById("userRole").setAttribute("data-user-email", data.email);

                    document.getElementById("userDetailContent").innerHTML = `
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>First Name:</strong> ${data.first_name}</div>
                            <div><strong>Last Name:</strong> ${data.last_name}</div>
                            <div><strong>Email:</strong> ${data.email}</div>
                            <div><strong>Student ID:</strong> ${data.student_id || 'N/A'}</div>
                            <div><strong>Role:</strong> ${data.role}</div>
                            <div><strong>Last Login:</strong> ${data.last_login || 'Never logged in'}</div>
                        </div>
                    `;

                    document.getElementById("userModal").classList.remove("hidden");
                });
        });
    });

    document.getElementById("closeModal").addEventListener("click", function() {
        document.getElementById("userModal").classList.add("hidden");
    });

    document.getElementById("closeModalBtn").addEventListener("click", function() {
        document.getElementById("userModal").classList.add("hidden");
    });

    let editUserBtn = document.getElementById("editUserBtn");
    let editUserModal = document.getElementById("editUserModal");
    let closeEditModal = document.getElementById("closeEditModal");
    let closeEditModalBtn = document.getElementById("closeEditModalBtn");

    editUserBtn.addEventListener("click", function() {
        let userId = document.getElementById("userFullName").getAttribute("data-user-id");
        let firstName = document.getElementById("userFullName").innerText.split(" ")[0];
        let lastName = document.getElementById("userFullName").innerText.split(" ")[1];
        let email = document.getElementById("userRole").getAttribute("data-user-email");
        let role = document.getElementById("userRole").innerText;

        document.getElementById("editUserId").value = userId;
        document.getElementById("editFirstName").value = firstName;
        document.getElementById("editLastName").value = lastName;
        document.getElementById("editEmail").value = email;
        document.getElementById("editRole").value = role;

        editUserModal.classList.remove("hidden");
    });

    closeEditModal.addEventListener("click", function() {
        editUserModal.classList.add("hidden");
    });

    closeEditModalBtn.addEventListener("click", function() {
        editUserModal.classList.add("hidden");
    });

    document.getElementById("editUserForm").addEventListener("submit", function(e) {
        e.preventDefault();

        let formData = new FormData(this);
        
        fetch("{% url 'update_user' %}", {
            method: "POST",
            body: formData
        }).then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert("Failed to update user.");
            }
        });
    });
});

{% endblock %}